Parse.View.prototype.close=function(){this.remove();this.unbind();if(this.onClose){this.onClose()}};var QueryString=function(){var e={};var t=window.location.search.substring(1);var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(typeof e[i[0]]==="undefined"){e[i[0]]=i[1]}else if(typeof e[i[0]]==="string"){var s=[e[i[0]],i[1]];e[i[0]]=s}else{e[i[0]].push(i[1])}}return e}();var CHARING_CROSS=new google.maps.LatLng(51.507222,-.1275);var RESULTS_PER_PAGE=30;var dateDiff=function(e){var t=new Date(e);var n=new Date-t,r=n/1e3,i=r/60,s=i/60,o=s/24,u=o/7;if(u>=2)return Math.floor(u)+" weeks";else if(u>=1)return"1 week";else if(o>=2)return Math.floor(o)+" days";else if(o>=1)return"1 day";else if(s>=2)return Math.floor(s)+" hours";else if(s>=1)return"1 hour";else if(i>=30)return Math.floor(i)+" min";else return"moments ago"};$(function(){var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:"data/boroughnames.json",filter:function(e){return $.map(e,function(e){return{name:e}})}}});e.initialize();Parse.$=jQuery;Parse.initialize("5ITlOKP4A8ggw5KYLJnsHYyOoQ9CZydXeUDSqjiQ","lsm1ZGuKXFw1PLaU6WYHHSLN2o2V6FQd8675nfmi");window.fbAsyncInit=function(){Parse.FacebookUtils.init({appId:0x5940507c86aae,cookie:true,xfbml:true,version:"v2.1"})};(function(e,t,n){var r,i=e.getElementsByTagName(t)[0];if(e.getElementById(n)){return}r=e.createElement(t);r.id=n;r.src="//connect.facebook.net/en_US/sdk.js";i.parentNode.insertBefore(r,i)})(document,"script","facebook-jssdk");var t=Parse.Object.extend("Listing");var n=Parse.Object.extend("FeedEntry",{defaults:{num_comments:0,availability:"1",users_liked:[],users_seen:[],shortlisted:false},seeDetails:function(){if(Parse.User.current()&&!this.seenByCurrentUser()){this.addUnique("users_seen",Parse.User.current());this.save()}},seenByCurrentUser:function(){if(Parse.User.current()){return _.chain(this.get("users_seen")).map(function(e){return e.id}).contains(Parse.User.current().id).value()}else{return false}},like:function(){if(Parse.User.current()){if(!this.get("shortlisted")){this.set("shortlisted",true);this.set("shortlisted_by",Parse.User.current())}else{if(this.shortlistedByCurrentUser()){this.set("shortlisted",false)}}if(this.likedByCurrentUser()){this.remove("users_liked",Parse.User.current())}else{this.addUnique("users_liked",Parse.User.current())}this.save({group:f.get("group")})}else{}},likedByCurrentUser:function(){if(Parse.User.current()){return _.chain(this.get("users_liked")).map(function(e){return e.id}).contains(Parse.User.current().id).value()}else{return false}},shortlistedByCurrentUser:function(){if(Parse.User.current()&&this.get("shortlisted")){return this.get("shortlisted_by").id==Parse.User.current().id}else{return false}},setAvailability:function(e){this.set("availability",e?"1":"0");this.save({group:f.get("group")})}});var r=Parse.Collection.extend({model:t,comparator:function(e){return e.get("last_published_date")}});var i=Parse.View.extend({template:_.template($("#listing-template").html()),commentTemplate:_.template($("#comment-template").html()),callModalTemplate:_.template($("#call-modal-template").html()),featureModalTemplate:_.template($("#feature-modal-template").html()),events:{"mouseenter .listing-container":"highlightOn","mouseleave .listing-container":"highlightOff","keypress #new-comment":"commentOnEnter","click .listing-action.action-shortlist":"shortlist","click .listing-action.action-call":"showCallModal","click .price-agency":"trackAgencyFeeClicks","click .price-council":"trackCouncilTaxClicks"},initialize:function(){var e=this;_.bindAll(this,"saveComment","showCallModal","hideCallModal","trackAgencyFeeClicks","trackCouncilTaxClicks");this.entry=new n({listing:this.model});this.comments=[];if(f.get("group")){this.entry.set("group",f.get("group"))}if(Parse.User.current()){var t=new Parse.Query(n);t.equalTo("group",f.get("group"));t.equalTo("listing",this.model);t.first().then(function(t){if(t){e.entry=t;e.render();var n=new Parse.Query("Comment");n.equalTo("feed_entry",t).include("user").ascending("createdAt");return n.find()}}).then(function(t){if(t){e.comments=t;e.render()}})}this.renderMarker()},onClose:function(){this.marker.setMap(null);this.marker=null;this.entry&&this.entry.unbind("change",this.render);this.undelegateEvents()},render:function(){var e=this;var t=this.model.toJSON();t.nearest_station=this.model.get("nearest_station").toJSON();t.nearest_station.distance=this.model.get("location").milesTo(this.model.get("nearest_station").get("location"));var n=this.entry.toJSON();n.shortlisted_by_current=this.entry.shortlistedByCurrentUser();n.liked_by_current=this.entry.likedByCurrentUser();if(f.get("group")&&this.entry.get("shortlisted")){var r=_.filter(f.get("group").get("users"),function(t){return e.entry.get("shortlisted_by").id==t.id})[0];n.user_shortlisted_pic=r.get("profile_image_url")}n.users_liked_pics=[];if(f.get("group")){for(var i=0;i<this.entry.get("users_liked").length;i++){var s=_.filter(f.get("group").get("users"),function(t){return e.entry.get("users_liked")[i].id==t.id&&e.entry.get("shortlisted_by").id!=t.id})[0];s&&n.users_liked_pics.push(s.get("profile_image_url"))}}for(var o in n)t[o]=n[o];$(this.el).html(this.template(t));this.input=this.$("#new-comment");var u=this.$(".listing-img-container");u.owlCarousel({singleItem:true,lazyLoad:true});this.$(".target-next").click(function(){u.trigger("owl.next")});this.$(".target-prev").click(function(){u.trigger("owl.prev")});this.renderComments();return this},renderComments:function(e){this.$("#comments-container").html("");for(var t=0;t<this.comments.length;t++){this.$("#comments-container").append(this.commentTemplate({first_name:this.comments[t].get("user").get("first_name"),profile_image_url:this.comments[t].get("user").get("profile_image_url"),comment:this.comments[t].get("comment")}))}},renderMarker:function(){var e=this;var t=e.options.map;var n=new google.maps.LatLng(this.model.get("location").latitude,this.model.get("location").longitude);var r=t.getBounds();if(t.getCenter()==CHARING_CROSS){t.setCenter(n)}else if(!r.contains(n)){r.extend(n);t.fitBounds(r)}this.marker=new google.maps.Marker({position:n,map:t,title:this.model.get("price_per_month").toString()});google.maps.event.addListener(this.marker,"click",function(){$(".highlighted-container").removeClass("highlighted-container");$("#"+e.id+" .listing-container").addClass("highlighted-container");$(".col-content").animate({scrollTop:$(".col-content").scrollTop()+$("#search-container").height()-$(".navbar").height()+$("#"+e.id+" .listing-container").position().top-$("#"+e.id+" .listing-container").height()},1e3)})},highlightOn:function(){var e=this.options.map;if(!e.getBounds().contains(this.marker.getPosition())){var t=e.getBounds();t.extend(this.marker.getPosition());e.fitBounds(t)}this.marker.setAnimation(google.maps.Animation.BOUNCE)},highlightOff:function(){this.marker.setAnimation(null)},commentOnEnter:function(e){var t=this;if(Parse.User.current()){if(e.keyCode!=13)return;var n=Parse.Object.extend("Comment");var r=new n({comment:this.input.val().substr(0,1200),feed_entry:this.entry,user:Parse.User.current()});this.$("#comments-container").append(this.commentTemplate({first_name:Parse.User.current().get("first_name"),profile_image_url:Parse.User.current().get("profile_image_url"),comment:this.input.val().substr(0,1200)}));this.saveComment(r);this.input.val("")}else{}},saveComment:function(e){var t=this;var n=new Parse.Promise.as(this.entry);if(this.entry.isNew()){n=this.entry.save()}n.then(function(n){t.entry=n;e.set("feed_entry",n);return e.save()}).then(function(){var e=new Parse.Query("Comment");e.equalTo("feed_entry",t.entry).include("user").ascending("createdAt");return e.find()}).then(function(e){if(e){t.comments=e;t.render()}},function(e){console.log(e)})},shortlist:function(){if(Parse.User.current()){this.entry.like();this.render()}},showCallModal:function(){var e=this;$("body").append(e.callModalTemplate(this.model.toJSON()));$("#callModal").modal();Parse.Cloud.run("calledProperty",{listing_id:this.model.id});$("button.available-notsure").bind("click",e.hideCallModal);$("button.available-yes").bind("click",$.proxy(e.reportAvailable,e));$("button.available-no").bind("click",$.proxy(e.reportNotAvailable,e));$("html").bind("click",function(e){e.stopPropagation()});return false},hideCallModal:function(){$("button.available-notsure").unbind("click");$("button.available-yes").unbind("click");$("button.available-no").unbind("click");$(".action-modal-dialog").unbind("click");$("#callModal").modal("hide");$("#callModal").remove();$(".modal-backdrop").remove()},reportAvailable:function(){if(Parse.User.current()){this.entry.setAvailability(true)}else{Parse.Cloud.run("logAvailabilityReport",{listing_id:this.model.id,available:true})}this.hideCallModal();this.render()},reportNotAvailable:function(){if(Parse.User.current()){this.entry.setAvailability(false)}else{Parse.Cloud.run("logAvailabilityReport",{listing_id:this.model.id,available:false})}this.hideCallModal();this.render()},trackAgencyFeeClicks:function(e){var t={feature:"price-transparency",category:"agency-fees",user:Parse.User.current()?Parse.User.current().id:"anonymous",listing:this.model.id};Parse.Analytics.track("featureRequest",t);this.showFeatureModal(e)},trackCouncilTaxClicks:function(e){var t={feature:"price-transparency",category:"council-tax",user:Parse.User.current()?Parse.User.current().id:"anonymous",listing:this.model.id};Parse.Analytics.track("featureRequest",t);this.showFeatureModal(e)},showFeatureModal:function(e){e.stopPropagation();var t=this;$("body").append(this.featureModalTemplate());$("#featureModal").modal();$("button.close").bind("click",t.hideFeatureModal);$("html").bind("click",t.hideFeatureModal);$(".action-modal-dialog").bind("click",function(e){e.stopPropagation()});return false},hideFeatureModal:function(){console.log("hide");$("html").unbind("click");$("button.close").unbind("click");$(".action-modal-dialog").unbind("click");$("#featureModal").modal("hide");$("#featureModal").remove();$(".modal-backdrop").remove()}});var s=Parse.Object.extend("Search",{defaults:{areas:[],price_min:0,price_max:6e3,num_beds:[2],with_photos:true}});var o=Parse.View.extend({el:"#search-container",template:_.template($("#search-template").html()),transitLayerTemplate:_.template($("#map-buttons-template").html()),statsTemplate:_.template($("#stats-template").html()),events:{"change #areas":"changeAreas","change .num-beds-select":"changeNumBeds","change #price-min":"changePriceMin","change #price-max":"changePriceMax","change #with-photos":"changeWithPhotos"},initialize:function(){_.bindAll(this,"render","performSearch","performNewSearch","initializeMap","saveSearch");this.$el.html(this.template(this.model.toJSON()));this.initializeControls();this.resultsPage=0;this.initializeMap();google.maps.event.addListenerOnce(this.map,"idle",this.performNewSearch);this.model.bind("change",this.performNewSearch);this.model.bind("change",this.render);this.listingViews=[]},initializeControls:function(){$(".btn-number").click(function(e){e.preventDefault();fieldName=$(this).attr("data-field");type=$(this).attr("data-type");var t=$("input[name='"+fieldName+"']");var n=parseInt(t.val());if(!isNaN(n)){if(type=="minus"){if(n>t.attr("min")){t.val(n-1).change()}if(parseInt(t.val())==t.attr("min")){$(this).attr("disabled",true)}}else if(type=="plus"){if(n<t.attr("max")){t.val(n+1).change()}if(parseInt(t.val())==t.attr("max")){$(this).attr("disabled",true)}}}else{t.val(0)}});$(".input-number").focusin(function(){$(this).data("oldValue",$(this).val())});$(".input-number").change(function(){minValue=parseInt($(this).attr("min"));maxValue=parseInt($(this).attr("max"));valueCurrent=parseInt($(this).val());name=$(this).attr("name");if(valueCurrent>=minValue){$(".btn-number[data-type='minus'][data-field='"+name+"']").removeAttr("disabled")}else{alert("Sorry, the minimum value was reached");$(this).val($(this).data("oldValue"))}if(valueCurrent<=maxValue){$(".btn-number[data-type='plus'][data-field='"+name+"']").removeAttr("disabled")}else{alert("Sorry, the maximum value was reached");$(this).val($(this).data("oldValue"))}});$(".input-number").keydown(function(e){if($.inArray(e.keyCode,[46,8,9,27,13,190])!==-1||e.keyCode==65&&e.ctrlKey===true||e.keyCode>=35&&e.keyCode<=39){return}if((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)){e.preventDefault()}});$(".price-range-slider").slider({range:true,min:0,max:6e3,step:50,values:[this.model.get("price_min"),this.model.get("price_max")],slide:function(e,t){$("#price-min").val(t.values[0]);$("#price-max").val(t.values[1]);if(t.values[1]==6e3)$("#price-max").val(t.values[1]+"+")},stop:function(e,t){if(t.value==t.values[0])$("#price-min").trigger("change");else $("#price-max").trigger("change")}});$("#areas").tagsinput({freeInput:false,typeaheadjs:{name:"boroughnames",displayKey:"name",valueKey:"name",source:e.ttAdapter()}})},initializeMap:function(){var e=this;var t={zoom:12,minZoom:10,maxZoom:17,center:CHARING_CROSS};var n=new google.maps.Map(document.getElementById("map-canvas"),t);this.map=n;n.data.loadGeoJson("data/boroughGeo.json");n.data.setStyle(function(e){var t=0;var n=0;if(e.getProperty("isSelected")){t=.8;n=.1}return{fillOpacity:n,fillColor:"#2980b9",strokeColor:"#2980b9",strokeOpacity:t,strokeWeight:3}});n.data.addListener("click",function(e){var t=!e.feature.getProperty("isSelected");var r=e.feature;r.setProperty("isSelected",t);$("#areas").tagsinput(t?"add":"remove",e.feature.getProperty("name"));if(!t){n.data.revertStyle();n.data.remove(r);n.data.add(r)}});n.data.addListener("addfeature",function(t){var n=e.model.get("areas");t.feature.setProperty("isSelected",_.contains(n,t.feature.getProperty("name")))});n.data.addListener("mouseover",function(e){n.data.revertStyle();n.data.overrideStyle(e.feature,{strokeOpacity:.8,strokeWeight:4})});n.data.addListener("mouseout",function(e){n.data.revertStyle()});$("#map-container").append(this.transitLayerTemplate());var r=new google.maps.TransitLayer;r.setMap(n);var i=document.getElementById("transit-wpr");n.controls[google.maps.ControlPosition.TOP_RIGHT].push(i);google.maps.event.addDomListener(i,"click",function(){r.setMap(r.getMap()?null:n)})},render:function(){var e=this;this.delegateEvents();this.$("#stats-row").html(this.statsTemplate({showingFirst:Math.min(this.count,(this.resultsPage+1)*RESULTS_PER_PAGE),count:this.count,expected:this.count/5,isNew:this.model.isNew(),hasChanged:this.model.dirty()}));$("button.btn-save-search").bind("click",$.proxy(e.saveSearch,e))},remove:function(){this.$el.empty().off();return this},onClose:function(){this.model.unbind("change",this.render);this.model.unbind("change",this.performSearch);this.clearResults()},changeAreas:function(e){var t=[];if(e.target.value.length>0){t=e.target.value.split(",")}if(!(t.length==0&&this.model.get("areas").length==0)){this.model.set({areas:t})}var t=this.model.get("areas");this.map.data.forEach(function(e){e.setProperty("isSelected",_.contains(t,e.getProperty("name")))})},changeNumBeds:function(e){var t=this.model.get("num_beds");var n=parseInt(e.target.value);t=n==1?[n,0]:[n];this.model.set({num_beds:t})},changePriceMin:function(e){this.model.set({price_min:parseInt(e.target.value)})},changePriceMax:function(e){this.model.set({price_max:parseInt(e.target.value)})},changeWithPhotos:function(e){this.model.set({with_photos:e.target.checked})},performNewSearch:function(){this.resultsPage=0;this.performSearch()},performSearch:function(){var e=this;this.clearResults();this.removeSpinner();$("#list-container #load-more").remove();this.insertSpinner();if(this.searchPromise)this.searchPromise._resolvedCallbacks=[];var t=new Date;t.setDate(t.getDate()-5);var n=Parse.Object.extend("Listing");var r=new Parse.Query(n);r.select(["agent_name","agent_phone","last_published_date","outcode","borough","displayable_address","num_bedrooms","price_per_month","image_urls","location","nearest_station","num_likes","num_seen"]).include("nearest_station").skip(this.resultsPage*RESULTS_PER_PAGE).descending("last_published_date").greaterThanOrEqualTo("last_published_date",t).greaterThan("num_images",0);if(this.model.get("num_beds").length>0){var s=this.model.get("num_beds").slice(0);r.containedIn("num_bedrooms",s)}if(this.model.get("areas").length>0){r.containedIn("borough",this.model.get("areas"))}r.greaterThanOrEqualTo("price_per_month",this.model.get("price_min"));if(this.model.get("price_max")<6e3){r.lessThanOrEqualTo("price_per_month",this.model.get("price_max"))}this.searchPromise=r.count().then(function(t){e.count=t;e.render();r.limit(RESULTS_PER_PAGE);return r.find()});this.searchPromise.done(function(t){e.clearResults();e.removeSpinner();$("#list-container #load-more").remove();for(var n=0;n<t.length;n++){var r=new i({model:t[n],id:t[n].id,map:e.map});e.listingViews.push(r);this.$("#list-container").append(r.render().el)}if(e.count>e.resultsPage*RESULTS_PER_PAGE+t.length){this.$("#list-container").append($("#load-more").clone());$("#load-more").bind("click",$.proxy(e.advancePage,e))}})},advancePage:function(){this.resultsPage++;this.performSearch()},insertSpinner:function(){$("#list-placeholder").clone().prependTo("#list-container")},removeSpinner:function(){$("#list-container #list-placeholder").remove()},clearResults:function(){if(this.resultsPage==0){_.map(this.listingViews,function(e){e.close()});this.listingViews=[]}},saveSearch:function(){var e=this;if(Parse.User.current()){if(this.model.isNew()){f.get("group").save({search:this.model}).then(function(){e.render()})}else{this.model.save().then(function(){e.render()})}}}});var u=Parse.View.extend({inviteModalTemplate:_.template($("#invite-modal-template").html()),el:$("#app-container"),navEl:".button-container",events:{"click .login-fb":"logInFb","click .log-out":"logOut"},initialize:function(){_.bindAll(this,"logInFb","logOut","render");if(QueryString.num_beds){var e=_.map(QueryString.num_beds.split(","),function(e){return parseInt(e)});if(e.length>0)f.set({num_beds:e})}this.render()},logInFb:function(e){var t=this;Parse.FacebookUtils.logIn("public_profile,email,user_friends",{success:function(e){Parse.User.current().fetch().then(function(){if(t.searchView){t.searchView.close();delete this.searchView}t.render()})},error:function(e,n){t.$("input.login-fb").removeAttr("disabled")}});this.$("input.login-fb").attr("disabled","disabled");return false},logOut:function(e){Parse.User.logOut();if(this.searchView){this.searchView.close();delete this.searchView}this.render()},showInviteModal:function(){var e=this;$("body").append(e.inviteModalTemplate({code:f.get("group").get("group_name")}));$("#inviteModal").modal();$("html").bind("click",e.hideInviteModal);$("button.close").bind("click",e.hideInviteModal);$(".action-modal-dialog").bind("click",function(e){e.stopPropagation()});$(".btn-fb").bind("click",$.proxy(e.sendFbMessage,e));return false},hideInviteModal:function(){$("html").unbind("click");$("button.close").unbind("click");$(".action-modal-dialog").unbind("click");$("#inviteModal").modal("hide");$("#inviteModal").remove();$(".modal-backdrop").remove()},sendFbMessage:function(){FB.ui({app_id:0x5940507c86aae,method:"send",link:"http://www.housequest.co.uk?invite="+f.get("group").get("group_name")})},render:function(){var e=this;if(Parse.User.current()){var t=Parse.Object.extend("Group");var n=new Parse.Query(t);n.equalTo("users",Parse.User.current());n.include("users");n.include("search");n.first().then(function(t){f.set({group:t});var n=_.template($("#nav-main-template").html());var r=_.chain(f.get("group").get("users")).filter(function(e){return e.id!=Parse.User.current().id}).map(function(e){return{first_name:e.get("first_name"),profile_img:e.get("profile_image_url")}}).value();$(e.navEl).html(n({users:r}));$(".user-invite").bind("click",$.proxy(e.showInviteModal,e));var i=t.has("search")?t.get("search"):new s({num_beds:f.get("num_beds")});e.searchView=new o({model:i})})}else{$(this.navEl).html(_.template($("#nav-login-template").html()));this.searchView=new o({model:new s({num_beds:f.get("num_beds")})})}this.delegateEvents()}});var a=Parse.Object.extend("AppState",{defaults:{group:undefined,num_beds:[2]}});var f=new a;new u})